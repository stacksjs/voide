<template>
  <div id="chatContainer" class="flex-1 relative flex flex-col overflow-hidden">
    <!-- Prompt Overlay (shown when Claude CLI asks for input) -->
    <div id="promptOverlay" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-monokai-bg border border-monokai-border rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
        <p id="promptText" class="text-sm text-monokai-fg mb-4">Please select an option:</p>
        <div id="promptOptions" class="flex flex-wrap gap-2"></div>
      </div>
    </div>

    <!-- Welcome State (shown when no messages) -->
    <div id="welcomeState" class="flex-1 flex flex-col items-center justify-center">
      <div class="text-center mb-8">
        <div class="flex items-center justify-center gap-3 mb-2">
          <span class="text-3xl text-monokai-yellow">✺</span>
          <h1 id="greetingText" class="text-4xl font-light text-monokai-fg/90">Hello</h1>
        </div>
        <p class="text-sm text-monokai-gray mt-4">Type or speak to start a conversation</p>
      </div>
    </div>

    <!-- Chat State (shown when has messages) -->
    <div id="chatState" class="hidden flex-1 overflow-y-auto">
      <div id="messagesContainer" class="max-w-3xl mx-auto px-4 py-6 space-y-6">
        <!-- Messages will be rendered here -->
      </div>
    </div>

  </div>
</template>

<script client>
(() => {
  const API_BASE_URL = 'http://localhost:3008/voide';

  let renderedCount = 0;
  const messageElements = new Map();
  const messageUpdates = new Map();
  let isCurrentlyProcessing = false;

  // =========================================================================
  // Greeting
  // =========================================================================

  function getGreeting() {
    const hour = new Date().getHours();
    if (hour >= 5 && hour < 12) return 'Good morning';
    if (hour >= 12 && hour < 17) return 'Good afternoon';
    if (hour >= 17 && hour < 21) return 'Good evening';
    return 'Good night';
  }

  function getUserName() {
    try {
      const settings = localStorage.getItem('voide-settings');
      if (settings) {
        const parsed = JSON.parse(settings);
        if (parsed.userName) return parsed.userName;
      }
    } catch (e) {}
    return null;
  }

  function updateGreeting() {
    const el = document.getElementById('greetingText');
    if (!el) return;
    const name = getUserName();
    el.textContent = name ? `${getGreeting()}, ${name}` : getGreeting();
  }

  // =========================================================================
  // Helpers
  // =========================================================================

  function isNearBottom(el) {
    const threshold = 100;
    return el.scrollHeight - el.scrollTop - el.clientHeight < threshold;
  }

  function scrollToBottom(el) {
    el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function renderMarkdown(text) {
    if (!text) return '';

    // Filter out "*thinking*" and "thinking..." patterns from Claude's response
    let cleaned = text
      .replace(/\*thinking\*\s*/gi, '')  // Remove *thinking* anywhere
      .replace(/^thinking\.\.\.\s*/gim, '')  // Remove "thinking..." at start of lines
      .replace(/\nthinking\.\.\.\s*/gi, '\n');  // Remove "thinking..." after newlines

    let html = escapeHtml(cleaned);

    // Code blocks (preserve newlines inside)
    const codeBlocks = [];
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (m, lang, code) => {
      const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
      codeBlocks.push(`<pre class="bg-monokai-bg-dark border border-monokai-border/40 rounded-lg p-3 my-3 overflow-x-auto"><code class="text-monokai-green text-xs whitespace-pre-wrap">${code.trim()}</code></pre>`);
      return placeholder;
    });

    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code class="bg-monokai-bg-dark text-monokai-cyan px-1.5 py-0.5 rounded text-xs">$1</code>');

    // Headers
    html = html.replace(/^### (.+)$/gm, '<h3 class="text-monokai-fg text-base font-semibold mt-4 mb-2">$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2 class="text-monokai-fg text-lg font-semibold mt-4 mb-2">$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h1 class="text-monokai-fg text-xl font-bold mt-4 mb-2">$1</h1>');

    // Bold and italic
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong class="text-monokai-fg font-semibold">$1</strong>');
    html = html.replace(/\*([^*]+)\*/g, '<em class="italic">$1</em>');

    // Links
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-monokai-cyan underline hover:text-monokai-cyan/80">$1</a>');

    // Lists
    html = html.replace(/^- (.+)$/gm, '<li class="ml-4 list-disc text-monokai-fg/80">$1</li>');

    // Horizontal rule
    html = html.replace(/^---$/gm, '<hr class="border-monokai-border/40 my-4">');

    // Convert newlines to <br> (after all line-based processing)
    html = html.replace(/\n/g, '<br>');

    // Restore code blocks
    codeBlocks.forEach((block, i) => {
      html = html.replace(`__CODE_BLOCK_${i}__`, block);
    });

    return html;
  }

  // =========================================================================
  // Message Rendering
  // =========================================================================

  let messageIdCounter = 0;

  function createMessageHtml(msg) {
    const isUser = msg.type === 'user';
    const isError = msg.type === 'error';
    const isSystem = msg.type === 'system';
    const msgId = `msg-${messageIdCounter++}`;

    // Loading indicator - show avatar with empty content (thinking will be appended)
    if (msg.content === '...') {
      return `<div class="flex items-start gap-3">
        <div class="flex-shrink-0 w-7 h-7 rounded-full bg-monokai-purple flex items-center justify-center">
          <span class="text-white text-xs font-medium">V</span>
        </div>
        <div class="flex-1 assistant-content"></div>
      </div>`;
    }

    // Get preview text (first line or first 100 chars)
    const previewText = msg.content.split('\n')[0].substring(0, 100) + (msg.content.length > 100 ? '...' : '');

    // User message - right aligned with cyan accent
    if (isUser) {
      return `<div class="group flex items-start justify-end gap-2" id="${msgId}">
        <button class="collapse-btn" data-collapse="${msgId}" title="Collapse" style="width: 28px; height: 28px; background: #ff6188; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; cursor: pointer; flex-shrink: 0;">▼</button>
        <div class="max-w-[80%] bg-monokai-cyan/10 border-l-2 border-monokai-cyan rounded-2xl rounded-br-sm px-4 py-3">
          <p class="msg-content text-sm text-monokai-fg leading-relaxed whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
          <p class="msg-preview hidden text-sm text-monokai-fg/60 leading-relaxed whitespace-pre-wrap">${escapeHtml(previewText)}</p>
        </div>
      </div>`;
    }

    // Error message
    if (isError) {
      return `<div class="group flex items-start gap-2" id="${msgId}">
        <div class="flex-shrink-0 w-7 h-7 rounded-full bg-monokai-pink/20 flex items-center justify-center">
          <span class="text-monokai-pink text-xs">!</span>
        </div>
        <div class="flex-1 bg-monokai-pink/10 border-l-2 border-monokai-pink rounded-2xl rounded-bl-sm px-4 py-3">
          <p class="msg-content text-sm text-monokai-pink/90 leading-relaxed">${escapeHtml(msg.content)}</p>
          <p class="msg-preview hidden text-sm text-monokai-pink/60">${escapeHtml(previewText)}</p>
        </div>
        <button class="collapse-btn flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center cursor-pointer" data-collapse="${msgId}" title="Collapse/Expand" style="background: #727072; color: #fcfcfa;">
          <svg class="collapse-icon" style="width: 16px; height: 16px;" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg>
        </button>
      </div>`;
    }

    // System message - subtle italic (no collapse for system messages)
    if (isSystem) {
      return `<div class="text-center py-2">
        <span class="text-xs text-monokai-gray italic">${escapeHtml(msg.content)}</span>
      </div>`;
    }

    // Assistant message - left aligned with purple accent
    const renderedContent = renderMarkdown(msg.content);
    return `<div class="group flex items-start gap-2" id="${msgId}">
      <div class="flex-shrink-0 w-7 h-7 rounded-full bg-monokai-purple flex items-center justify-center">
        <span class="text-white text-xs font-medium">V</span>
      </div>
      <div class="flex-1 bg-monokai-purple/10 border-l-2 border-monokai-purple rounded-2xl rounded-bl-sm px-4 py-3 assistant-content">
        <div class="msg-content text-sm text-monokai-fg/90 leading-relaxed">${renderedContent}</div>
        <p class="msg-preview hidden text-sm text-monokai-fg/60 italic">${escapeHtml(previewText)}</p>
      </div>
      <button class="collapse-btn" data-collapse="${msgId}" title="Collapse" style="width: 28px; height: 28px; background: #ff6188; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; cursor: pointer; flex-shrink: 0;">▼</button>
    </div>`;
  }

  function toggleChatState(hasMessages) {
    const welcomeState = document.getElementById('welcomeState');
    const chatState = document.getElementById('chatState');

    if (hasMessages) {
      welcomeState?.classList.add('hidden');
      chatState?.classList.remove('hidden');
    } else {
      welcomeState?.classList.remove('hidden');
      chatState?.classList.add('hidden');
    }
  }

  function renderMessages(messages) {
    const container = document.getElementById('messagesContainer');
    const chatState = document.getElementById('chatState');
    if (!container) return;

    const messageArray = messages || [];
    toggleChatState(messageArray.length > 0);

    const shouldAutoScroll = chatState ? isNearBottom(chatState) : true;

    // Reset if messages were cleared
    if (messageArray.length < renderedCount) {
      renderedCount = 0;
      messageElements.clear();
      messageUpdates.clear();
      container.innerHTML = '';
    }

    // Update existing messages that changed
    for (let i = 0; i < messageArray.length; i++) {
      const msg = messageArray[i];
      if (!msg) continue;
      const existingEl = messageElements.get(i);
      const lastUpdate = messageUpdates.get(i);
      if (existingEl && msg.updated && msg.updated !== lastUpdate) {
        existingEl.innerHTML = createMessageHtml(msg);
        messageUpdates.set(i, msg.updated);
      }
    }

    // Add new messages
    while (renderedCount < messageArray.length) {
      const idx = renderedCount;
      const msg = messageArray[idx];
      if (!msg) break;
      const messageDiv = document.createElement('div');
      messageDiv.className = 'animate-fade-in';
      messageDiv.innerHTML = createMessageHtml(msg);
      container.appendChild(messageDiv);
      messageElements.set(idx, messageDiv);
      messageUpdates.set(idx, msg.updated || 0);
      renderedCount++;
    }

    if (shouldAutoScroll && chatState) {
      scrollToBottom(chatState);
    }

  }

  function init() {
    const stores = window.VoideStores;
    if (!stores) {
      setTimeout(init, 10);
      return;
    }

    const { appStore, chatStore, chatActions } = stores;

    console.log('[VoideTerminal] Initialized');

    // Set up greeting
    updateGreeting();

    // Respond to prompt from Claude
    function respondToPrompt(response) {
      const chat = chatStore.get();
      if (!chat.pendingPrompt) return;

      // Add user response as message
      chatActions.addMessage('user', response, 'You');
      chatActions.clearPendingPrompt();

      // Send response to backend
      fetch(API_BASE_URL + '/respond', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          promptId: chat.pendingPrompt.id,
          response: response
        })
      }).catch(error => {
        chatActions.addMessage('error', 'Failed to send response: ' + error.message, 'Error');
      });
    }

    // Render messages
    chatStore.subscribe(state => renderMessages(state.messages));

    // Event delegation for collapse buttons
    const container = document.getElementById('messagesContainer');
    container?.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-collapse]');
      if (btn) {
        const msgId = btn.getAttribute('data-collapse');
        toggleCollapse(msgId);
      }
    });

    // Subscribe to processing state
    appStore.subscribe(state => {
      isCurrentlyProcessing = state.isProcessing;
    });

    // Handle pending prompts
    chatStore.subscribe(state => {
      const overlay = document.getElementById('promptOverlay');
      const textEl = document.getElementById('promptText');
      const optionsEl = document.getElementById('promptOptions');

      if (!overlay || !textEl || !optionsEl) return;

      if (state.pendingPrompt) {
        textEl.textContent = state.pendingPrompt.text;
        optionsEl.innerHTML = '';

        state.pendingPrompt.options.forEach((option, i) => {
          const label = state.pendingPrompt.labels?.[i] || option;
          const btn = document.createElement('button');
          btn.className = 'px-4 py-2 text-sm font-medium bg-monokai-cyan text-monokai-bg rounded-lg cursor-pointer hover:bg-monokai-cyan/90 transition-colors';
          btn.textContent = label;
          btn.onclick = () => respondToPrompt(option);
          optionsEl.appendChild(btn);
        });

        overlay.classList.remove('hidden');
      } else {
        overlay.classList.add('hidden');
      }
    });

    // Toggle collapse state for a message
    function toggleCollapse(msgId) {
      const msgEl = document.getElementById(msgId);
      if (!msgEl) return;

      const content = msgEl.querySelector('.msg-content');
      const preview = msgEl.querySelector('.msg-preview');
      const icon = msgEl.querySelector('.collapse-icon');

      if (content && preview) {
        const isCollapsed = content.classList.contains('hidden');
        if (isCollapsed) {
          // Expand
          content.classList.remove('hidden');
          preview.classList.add('hidden');
          icon?.classList.remove('rotate-180');
        } else {
          // Collapse
          content.classList.add('hidden');
          preview.classList.remove('hidden');
          icon?.classList.add('rotate-180');
        }
      }
    }

    // Expose to window.voide
    window.voide = window.voide || {};
    Object.assign(window.voide, {
      respondToPrompt,
      toggleCollapse
    });
  }

  init();
})();
</script>

<template>
  <div id="chatContainer" class="flex-1 relative flex flex-col overflow-hidden">
    <!-- Prompt Overlay (shown when Claude CLI asks for input) -->
    <div id="promptOverlay" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-monokai-bg border border-monokai-border rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
        <p id="promptText" class="text-sm text-monokai-fg mb-4">Please select an option:</p>
        <div id="promptOptions" class="flex flex-wrap gap-2"></div>
      </div>
    </div>

    <!-- Welcome State (shown when no messages) -->
    <div id="welcomeState" class="flex-1 flex flex-col items-center justify-center">
      <div class="text-center mb-8">
        <div class="flex items-center justify-center gap-3 mb-2">
          <span class="text-3xl text-monokai-yellow">âœº</span>
          <h1 id="greetingText" class="text-4xl font-light text-monokai-fg/90">Hello</h1>
        </div>
        <p class="text-sm text-monokai-gray mt-4">Type or speak to start a conversation</p>
      </div>
    </div>

    <!-- Chat State (shown when has messages) -->
    <div id="chatState" class="hidden flex-1 overflow-y-auto">
      <div id="messagesContainer" class="max-w-3xl mx-auto px-4 py-6 space-y-6">
        <!-- Messages will be rendered here -->
      </div>
    </div>
  </div>
</template>

<script client>
(() => {
  const API_BASE_URL = 'http://localhost:3008/voide';

  let renderedCount = 0;
  const messageElements = new Map();
  const messageUpdates = new Map();

  // =========================================================================
  // Greeting
  // =========================================================================

  function getGreeting() {
    const hour = new Date().getHours();
    if (hour >= 5 && hour < 12) return 'Good morning';
    if (hour >= 12 && hour < 17) return 'Good afternoon';
    if (hour >= 17 && hour < 21) return 'Good evening';
    return 'Good night';
  }

  function getUserName() {
    try {
      const settings = localStorage.getItem('voide-settings');
      if (settings) {
        const parsed = JSON.parse(settings);
        if (parsed.userName) return parsed.userName;
      }
    } catch (e) {}
    return null;
  }

  function updateGreeting() {
    const el = document.getElementById('greetingText');
    if (!el) return;
    const name = getUserName();
    el.textContent = name ? `${getGreeting()}, ${name}` : getGreeting();
  }

  // =========================================================================
  // Helpers
  // =========================================================================

  function isNearBottom(el) {
    const threshold = 100;
    return el.scrollHeight - el.scrollTop - el.clientHeight < threshold;
  }

  function scrollToBottom(el) {
    el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function renderMarkdown(text) {
    if (!text) return '';
    let html = escapeHtml(text);
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (m, lang, code) =>
      `<pre class="bg-monokai-bg-dark border border-monokai-border/40 rounded-lg p-3 my-3 overflow-x-auto"><code class="text-monokai-green text-xs">${code.trim()}</code></pre>`
    );
    html = html.replace(/`([^`]+)`/g, '<code class="bg-monokai-bg-dark text-monokai-cyan px-1.5 py-0.5 rounded text-xs">$1</code>');
    html = html.replace(/^### (.+)$/gm, '<h3 class="text-monokai-fg text-base font-semibold mt-4 mb-2">$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2 class="text-monokai-fg text-lg font-semibold mt-4 mb-2">$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h1 class="text-monokai-fg text-xl font-bold mt-4 mb-2">$1</h1>');
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong class="text-monokai-fg font-semibold">$1</strong>');
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-monokai-cyan underline hover:text-monokai-cyan/80">$1</a>');
    html = html.replace(/^- (.+)$/gm, '<li class="ml-4 list-disc text-monokai-fg/80">$1</li>');
    html = html.replace(/^---$/gm, '<hr class="border-monokai-border/40 my-4">');
    return html;
  }

  // =========================================================================
  // Message Rendering
  // =========================================================================

  function createMessageHtml(msg) {
    const isUser = msg.type === 'user';
    const isError = msg.type === 'error';
    const isSystem = msg.type === 'system';

    // Loading indicator
    if (msg.content === '...') {
      return `<div class="flex items-center gap-2 py-2">
        <div class="animate-bounce w-2 h-2 bg-monokai-purple rounded-full"></div>
        <div class="animate-bounce w-2 h-2 bg-monokai-purple rounded-full" style="animation-delay:150ms"></div>
        <div class="animate-bounce w-2 h-2 bg-monokai-purple rounded-full" style="animation-delay:300ms"></div>
      </div>`;
    }

    // User message - right aligned, subtle background
    if (isUser) {
      return `<div class="flex justify-end">
        <div class="max-w-[80%] bg-monokai-bg-dark rounded-2xl rounded-br-sm px-4 py-3">
          <p class="text-sm text-monokai-fg leading-relaxed whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
        </div>
      </div>`;
    }

    // Error message
    if (isError) {
      return `<div class="flex items-start gap-3">
        <div class="flex-shrink-0 w-7 h-7 rounded-full bg-monokai-pink/20 flex items-center justify-center">
          <span class="text-monokai-pink text-xs">!</span>
        </div>
        <div class="flex-1 text-sm text-monokai-pink/90 leading-relaxed">${escapeHtml(msg.content)}</div>
      </div>`;
    }

    // System message - subtle italic
    if (isSystem) {
      return `<div class="text-center py-2">
        <span class="text-xs text-monokai-gray italic">${escapeHtml(msg.content)}</span>
      </div>`;
    }

    // Assistant message - left aligned, clean
    return `<div class="flex items-start gap-3">
      <div class="flex-shrink-0 w-7 h-7 rounded-full bg-monokai-purple flex items-center justify-center">
        <span class="text-white text-xs font-medium">V</span>
      </div>
      <div class="flex-1 text-sm text-monokai-fg/90 leading-relaxed">${renderMarkdown(msg.content)}</div>
    </div>`;
  }

  function toggleChatState(hasMessages) {
    const welcomeState = document.getElementById('welcomeState');
    const chatState = document.getElementById('chatState');

    if (hasMessages) {
      welcomeState?.classList.add('hidden');
      chatState?.classList.remove('hidden');
    } else {
      welcomeState?.classList.remove('hidden');
      chatState?.classList.add('hidden');
    }
  }

  function renderMessages(messages) {
    const container = document.getElementById('messagesContainer');
    const chatState = document.getElementById('chatState');
    if (!container) return;

    const messageArray = messages || [];
    toggleChatState(messageArray.length > 0);

    const shouldAutoScroll = chatState ? isNearBottom(chatState) : true;

    // Reset if messages were cleared
    if (messageArray.length < renderedCount) {
      renderedCount = 0;
      messageElements.clear();
      messageUpdates.clear();
      container.innerHTML = '';
    }

    // Update existing messages that changed
    for (let i = 0; i < messageArray.length; i++) {
      const msg = messageArray[i];
      if (!msg) continue;
      const existingEl = messageElements.get(i);
      const lastUpdate = messageUpdates.get(i);
      if (existingEl && msg.updated && msg.updated !== lastUpdate) {
        existingEl.innerHTML = createMessageHtml(msg);
        messageUpdates.set(i, msg.updated);
      }
    }

    // Add new messages
    while (renderedCount < messageArray.length) {
      const idx = renderedCount;
      const msg = messageArray[idx];
      if (!msg) break;
      const messageDiv = document.createElement('div');
      messageDiv.className = 'animate-fade-in';
      messageDiv.innerHTML = createMessageHtml(msg);
      container.appendChild(messageDiv);
      messageElements.set(idx, messageDiv);
      messageUpdates.set(idx, msg.updated || 0);
      renderedCount++;
    }

    if (shouldAutoScroll && chatState) {
      scrollToBottom(chatState);
    }
  }

  function init() {
    const stores = window.VoideStores;
    if (!stores) {
      setTimeout(init, 10);
      return;
    }

    const { appStore, chatStore, chatActions } = stores;

    console.log('[VoideTerminal] Initialized');

    // Set up greeting
    updateGreeting();

    // Respond to prompt from Claude
    function respondToPrompt(response) {
      const chat = chatStore.get();
      if (!chat.pendingPrompt) return;

      // Add user response as message
      chatActions.addMessage('user', response, 'You');
      chatActions.clearPendingPrompt();

      // Send response to backend
      fetch(API_BASE_URL + '/respond', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          promptId: chat.pendingPrompt.id,
          response: response
        })
      }).catch(error => {
        chatActions.addMessage('error', 'Failed to send response: ' + error.message, 'Error');
      });
    }

    // Render messages
    chatStore.subscribe(state => renderMessages(state.messages));

    // Handle pending prompts
    chatStore.subscribe(state => {
      const overlay = document.getElementById('promptOverlay');
      const textEl = document.getElementById('promptText');
      const optionsEl = document.getElementById('promptOptions');

      if (!overlay || !textEl || !optionsEl) return;

      if (state.pendingPrompt) {
        textEl.textContent = state.pendingPrompt.text;
        optionsEl.innerHTML = '';

        state.pendingPrompt.options.forEach((option, i) => {
          const label = state.pendingPrompt.labels?.[i] || option;
          const btn = document.createElement('button');
          btn.className = 'px-4 py-2 text-sm font-medium bg-monokai-cyan text-monokai-bg rounded-lg cursor-pointer hover:bg-monokai-cyan/90 transition-colors';
          btn.textContent = label;
          btn.onclick = () => respondToPrompt(option);
          optionsEl.appendChild(btn);
        });

        overlay.classList.remove('hidden');
      } else {
        overlay.classList.add('hidden');
      }
    });

    // Expose to window.voide
    window.voide = window.voide || {};
    Object.assign(window.voide, {
      respondToPrompt
    });
  }

  init();
})();
</script>
